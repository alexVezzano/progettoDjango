{% extends 'base.html' %}

{% block head %}
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/home.css' %}">

{% endblock %}

{%block title%}
    Home
{%endblock%}


{% block content %}
    
    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center">
            <h1>Benvenuto!</h1>
            <!-- Filtro per categoria e ricerca -->
            <form method="get" class="form-inline d-flex align-items-center position-relative">
                <div class="form-group mb-2 mr-2">
                    <select name="categoria" class="form-control">
                        <option value="">Tutte le categorie</option>
                        {% for categoria in categorie %}
                            <option value="{{ categoria.0 }}" {% if categoria_selezionata == categoria.0 %}selected{% endif %}>
                                {{ categoria.1 }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group mb-2 mr-2 position-relative">
                    <input type="text" id="search-input" name="query" class="form-control" placeholder="Cerca...">
                    <div id="suggestions" class="list-group"></div>
                </div>
                <button type="submit" class="btn btn-primary mb-2">Filtra</button>
            </form>
        </div>
        <!-- Lista delle aste -->
        <div class="row">
            {% for item in aste_con_prezzo %}
                <div class="col-md-3 mb-4">
                    <div class="card">
                        <img src="{{ item.asta.prodotto.immagine.url }}" class="card-img-top" alt="Immagine Prodotto">
                        <div class="card-body">
                            <h5 class="card-title">{{ item.asta.prodotto.nome }}</h5>
                            <p class="card-text">Asta di: {{ item.asta.venditore }}</p>
                            <p class="card-text">Prezzo: <b>€{{ item.prezzo_corrente }}</b></p>
                            <p class="card-text">
                                {% if item.asta.end_time.date == today %}
                                    Termine: {{ item.asta.end_time|time:"H:i" }}
                                {% else %}
                                    Termine: {{ item.asta.end_time|date:"d/m/Y H:i" }}
                                {% endif %}
                            </p>
                            <a href="{% url 'asta:partecipa_asta' item.asta.id %}" class="btn btn-primary">Entra nell'Asta</a>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>

        {% if page_obj.paginator.count > 12 %}
            <div class="d-flex justify-content-center">
                <nav aria-label="Page navigation">
                    <ul class="pagination">
                        {% if page_obj.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?{% if categoria_selezionata %}categoria={{ categoria_selezionata }}&{% endif %}{% if query %}query={{ query }}&{% endif %}page={{ page_obj.previous_page_number }}" aria-label="Previous">
                                    <span aria-hidden="true">&laquo;</span>
                                </a>
                            </li>
                        {% endif %}
                        {% for num in page_obj.paginator.page_range %}
                            <li class="page-item {% if page_obj.number == num %}active{% endif %}">
                                <a class="page-link" href="?{% if categoria_selezionata %}categoria={{ categoria_selezionata }}&{% endif %}{% if query %}query={{ query }}&{% endif %}page={{ num }}">{{ num }}</a>
                            </li>
                        {% endfor %}
                        {% if page_obj.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?{% if categoria_selezionata %}categoria={{ categoria_selezionata }}&{% endif %}{% if query %}query={{ query }}&{% endif %}page={{ page_obj.next_page_number }}" aria-label="Next">
                                    <span aria-hidden="true">&raquo;</span>
                                </a>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
            </div>
        {% endif %}
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function() {
            $('#search-input').on('keyup', function() {
                var query = $(this).val();
                if (query.length > 2) {  // Avvia la ricerca solo se la query è più lunga di 2 caratteri
                    $.ajax({
                        url: "{% url 'asta:suggestions' %}",
                        data: {
                            'q': query
                        },
                        success: function(data) {
                            $('#suggestions').empty().show();
                            if (data.length > 0) {
                                data.forEach(function(item) {
                                    $('#suggestions').append('<a href="#" class="list-group-item list-group-item-action suggestion-item">' + item.prodotto__nome + '</a>');
                                });
                            } else {
                                $('#suggestions').append('<p class="list-group-item">Nessun suggerimento trovato</p>');
                            }
                        }
                    });
                } else {
                    $('#suggestions').hide();
                }
            });

            // Aggiorno la casella di testo quando un elemento della lista è cliccato
            $(document).on('click', '.suggestion-item', function() {
                $('#search-input').val($(this).text());
                $('#suggestions').hide();
            });

            // Nascondo la lista di suggerimenti quando clicco fuori
            $(document).click(function(event) {
                if (!$(event.target).closest('#search-input, #suggestions').length) {
                    $('#suggestions').hide();
                }
            });
        });
    </script> 

{% endblock %}